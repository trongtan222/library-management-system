<div class="container mt-4">
  <div class="card shadow-lg border-0 bg-dark text-white">
    <div class="card-header bg-primary text-white">
      <h3 class="mb-0">
        <i class="fa-solid fa-file-signature me-2"></i>Tạo Phiếu Mượn (Admin)
      </h3>
    </div>
    <div class="card-body p-4">
      <div class="row g-4">
        <!-- CỘT 1: CHỌN NGƯỜI DÙNG -->
        <div class="col-md-6 border-end border-secondary">
          <h5
            class="text-info mb-3 d-flex align-items-center justify-content-between"
          >
            <span
              ><i class="fa-solid fa-user me-2"></i>Bước 1: Chọn Độc Giả</span
            >
            <span class="badge bg-secondary">Auto-complete + thẻ tóm tắt</span>
          </h5>

          <!-- Input Tìm kiếm -->
          <div class="position-relative mb-3" *ngIf="!selectedUser">
            <div class="input-group input-group-lg shadow-sm">
              <span
                class="input-group-text bg-secondary text-white border-secondary"
              >
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input
                type="text"
                class="form-control bg-dark text-white border-secondary"
                placeholder="Nhập tên hoặc username..."
                [ngModel]="userSearchTerm"
                (ngModelChange)="onUserSearchChange($event)"
                autocomplete="off"
              />
            </div>

            <!-- List gợi ý -->
            <div
              class="list-group position-absolute w-100 mt-1 shadow"
              style="z-index: 1000"
              *ngIf="users.length > 0"
            >
              <button
                type="button"
                class="list-group-item list-group-item-action bg-dark border-secondary d-flex justify-content-between align-items-center"
                *ngFor="let u of users"
                (click)="selectUser(u)"
              >
                <div>
                  <strong>{{ u.name }}</strong>
                  <div class="small text-muted">
                    Username: {{ u.username }} • ID: {{ u.userId }}
                  </div>
                </div>
                <span class="badge bg-info text-dark">{{
                  u.role || u.roles[0] || "User"
                }}</span>
              </button>
            </div>
          </div>

          <!-- Thẻ User đã chọn + Smart validation -->
          <div
            class="selected-card p-3 rounded border border-success bg-dark text-white"
            *ngIf="selectedUser"
          >
            <div class="d-flex justify-content-between align-items-start">
              <div class="me-3">
                <h5 class="mb-1 text-success">{{ selectedUser.name }}</h5>
                <p class="mb-0 small">
                  Username:
                  <span class="fw-bold">{{ selectedUser.username }}</span> | ID:
                  <span class="fw-bold">{{ selectedUser.userId }}</span>
                </p>
                <p class="mb-0 small" *ngIf="selectedUser.email">
                  Email: <span class="fw-bold">{{ selectedUser.email }}</span>
                </p>
                <p class="mb-0 small">
                  Vai trò:
                  <span class="fw-bold">{{
                    selectedUser.role || selectedUser.roles[0] || "User"
                  }}</span>
                </p>
                <div *ngIf="selectedUser.role === 'Student'" class="mt-2">
                  <label class="form-label text-white">Lớp học:</label>
                  <input
                    type="text"
                    class="form-control form-control-sm bg-dark text-white border-secondary"
                    [(ngModel)]="selectedUser.className"
                    placeholder="Nhập lớp học..."
                  />
                </div>
              </div>
              <div class="grow">
                <div
                  class="alert"
                  [ngClass]="
                    userSummary.blocked ? 'alert-danger' : 'alert-secondary'
                  "
                >
                  <div
                    class="d-flex justify-content-between align-items-center mb-2"
                  >
                    <span class="fw-bold">Kiểm tra điều kiện mượn</span>
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.blocked ? 'bg-danger' : 'bg-success'
                      "
                    >
                      {{ userSummary.blocked ? "Chặn mượn" : "Đủ điều kiện" }}
                    </span>
                  </div>
                  <div class="d-flex flex-wrap gap-2 small">
                    <span class="badge bg-dark border border-secondary"
                      >Đang mượn: {{ userSummary.activeLoans }}/{{
                        userSummary.maxLoans
                      }}</span
                    >
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.overdueCount > 0
                          ? 'bg-danger'
                          : 'bg-secondary'
                      "
                      >Quá hạn: {{ userSummary.overdueCount }}</span
                    >
                    <span
                      class="badge"
                      [ngClass]="
                        userSummary.totalFine > 0
                          ? 'bg-warning text-dark'
                          : 'bg-secondary'
                      "
                    >
                      Phí phạt: {{ userSummary.totalFine | number : "1.0-0" }} đ
                    </span>
                  </div>
                  <div
                    *ngIf="userSummary.blocked"
                    class="mt-2 text-danger small fw-bold"
                  >
                    ⚠️ {{ userSummary.blockReason }}
                  </div>
                  <div *ngIf="selectedUser.loanHistory?.length" class="mt-2">
                    <span class="small text-info">Lịch sử gần đây:</span>
                    <ul class="list-group list-group-flush mt-1">
                      <li
                        class="list-group-item bg-dark text-white border-secondary"
                        *ngFor="let l of selectedUser.loanHistory"
                      >
                        <span class="fw-bold">{{ l.bookName }}</span>
                        <span class="text-info"
                          >({{ l.loanDate | date : "dd/MM/yyyy" }})</span
                        >
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <button
                class="btn btn-outline-danger btn-sm ms-2"
                (click)="clearSelectedUser()"
              >
                <i class="fa-solid fa-times"></i> Bỏ chọn
              </button>
            </div>
          </div>
        </div>

        <!-- CỘT 2: CHỌN SÁCH -->
        <div class="col-md-6">
          <h5
            class="text-warning mb-3 d-flex align-items-center justify-content-between"
          >
            <span class="d-flex align-items-center gap-2">
              <i class="fa-solid fa-book me-1"></i>
              <span>Bước 2: Quét/Chọn Sách (POS)</span>
              <span class="badge bg-info text-dark"
                >{{ cartCount }} trong giỏ</span
              >
            </span>
            <button
              class="btn btn-outline-info btn-sm"
              type="button"
              (click)="openScanner()"
            >
              <i class="fa-solid fa-barcode me-1"></i> Scan Barcode
            </button>
          </h5>

          <!-- Input Tìm kiếm -->
          <div class="position-relative mb-3" *ngIf="!selectedBook">
            <div class="input-group input-group-lg shadow-sm">
              <span
                class="input-group-text bg-secondary text-white border-secondary"
              >
                <i class="fa-solid fa-magnifying-glass"></i>
              </span>
              <input
                type="text"
                class="form-control bg-dark text-white border-secondary"
                placeholder="Nhập tên sách hoặc ISBN..."
                [ngModel]="bookSearchTerm"
                (ngModelChange)="onBookSearchChange($event)"
                autocomplete="off"
              />
            </div>

            <!-- List gợi ý -->
            <div
              class="list-group position-absolute w-100 mt-1 shadow"
              style="z-index: 1000"
              *ngIf="books.length > 0"
            >
              <button
                type="button"
                class="list-group-item list-group-item-action bg-dark text-white border-secondary book-suggestion-item"
                *ngFor="let b of books"
                (click)="selectBook(b)"
                [disabled]="b.numberOfCopiesAvailable === 0"
                [title]="b.numberOfCopiesAvailable === 0 ? 'Sách đã hết' : ''"
              >
                <div class="d-flex align-items-center">
                  <img
                    [src]="b.coverUrl || 'assets/images/placeholder.png'"
                    style="width: 40px; height: 55px; object-fit: cover"
                    class="me-2 rounded"
                  />
                  <div>
                    <div class="fw-bold">{{ b.name }}</div>
                    <small class="text-muted"
                      >ISBN: {{ b.isbn || "N/A" }}</small
                    >
                    <div class="small">
                      <span
                        [ngClass]="
                          b.numberOfCopiesAvailable > 0
                            ? 'text-success'
                            : 'text-danger'
                        "
                        >Còn: {{ b.numberOfCopiesAvailable }}</span
                      >
                    </div>
                  </div>
                </div>
              </button>
            </div>
          </div>

          <!-- Giỏ sách đã quét/chọn -->
          <div
            class="selected-card p-3 rounded border border-warning bg-dark text-white"
            *ngIf="cartCount > 0"
          >
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold text-warning">
                Danh sách đang mượn ({{ cartCount }})
              </div>
              <button
                class="btn btn-sm btn-outline-light"
                type="button"
                (click)="resetBooksOnly()"
              >
                <i class="fa-solid fa-rotate-left me-1"></i>Xoá sạch giỏ
              </button>
            </div>
            <div class="list-group list-group-flush bg-dark">
              <div
                class="list-group-item bg-dark text-white border-secondary d-flex align-items-center justify-content-between"
                *ngFor="let b of cartBooks"
              >
                <div class="d-flex align-items-center">
                  <img
                    [src]="b.coverUrl || 'assets/images/placeholder.png'"
                    style="width: 42px; height: 60px; object-fit: cover"
                    class="me-2 rounded"
                  />
                  <div>
                    <div class="fw-bold">{{ b.name }}</div>
                    <div class="small text-muted">
                      ISBN: {{ b.isbn || "N/A" }} | Còn:
                      {{ b.numberOfCopiesAvailable }}
                    </div>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-secondary">ID {{ b.id }}</span>
                  <button
                    class="btn btn-outline-danger btn-sm"
                    (click)="removeBookFromCart(b.id)"
                  >
                    <i class="fa-solid fa-times"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Thẻ Sách đã chọn (preview cuối) -->
          <div
            class="selected-card p-3 rounded border border-warning bg-dark text-white"
            *ngIf="selectedBook"
          >
            <div class="d-flex align-items-start">
              <img
                [src]="selectedBook.coverUrl || 'assets/images/placeholder.png'"
                style="width: 70px; height: 100px; object-fit: cover"
                class="me-3 rounded shadow-sm"
              />
              <div class="grow">
                <h5 class="mb-1 text-warning">{{ selectedBook.name }}</h5>
                <p class="mb-1 small">
                  Tác giả:
                  <span
                    *ngFor="let a of selectedBook.authors"
                    class="fw-bold text-info me-1"
                    >{{ a.name }}</span
                  >
                </p>
                <span class="badge bg-secondary"
                  >ID: {{ selectedBook.id }}</span
                >
                <p class="mb-1 small">
                  Năm XB:
                  <span class="fw-bold">{{ selectedBook.publishedYear }}</span>
                </p>
                <p class="mb-1 small">
                  ISBN: <span class="fw-bold">{{ selectedBook.isbn }}</span>
                </p>
                <p class="mb-1 small">
                  Số lượng còn:
                  <span
                    [ngClass]="
                      selectedBook.numberOfCopiesAvailable > 0
                        ? 'text-success fw-bold'
                        : 'text-danger fw-bold'
                    "
                    >{{ selectedBook.numberOfCopiesAvailable }}</span
                  >
                </p>
                <div
                  *ngIf="selectedBook.numberOfCopiesAvailable === 0"
                  class="alert alert-danger p-2 mt-2 text-white"
                >
                  Sách đã hết, không thể cấp!
                </div>
                <div
                  class="mt-3 p-2 rounded border border-secondary bg-opacity-50 bg-black"
                >
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <span class="text-info fw-bold">AI Gợi ý</span>
                    <span
                      *ngIf="aiLoading"
                      class="spinner-border spinner-border-sm text-info"
                    ></span>
                  </div>
                  <p class="mb-0 small" [class.text-muted]="!aiSuggestion">
                    {{
                      aiSuggestion ||
                        "Đang chờ chọn người dùng & sách để gợi ý..."
                    }}
                  </p>
                </div>
              </div>
              <button
                class="btn btn-outline-danger btn-sm"
                (click)="clearSelectedBook()"
              >
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <hr class="border-secondary my-4" />

      <!-- BƯỚC 3: CẤU HÌNH & SUBMIT -->
      <form #loanForm="ngForm" (ngSubmit)="createLoan()">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label class="form-label">Thời hạn mượn (Ngày)</label>
            <select
              class="form-select bg-dark text-white border-secondary"
              name="loanDays"
              [(ngModel)]="loanDays"
            >
              <option [ngValue]="7">7 Ngày (1 tuần)</option>
              <option [ngValue]="14">14 Ngày (2 tuần)</option>
              <option [ngValue]="30">30 Ngày (1 tháng)</option>
            </select>
          </div>
          <div class="col-md-8 text-end">
            <button
              class="btn btn-outline-secondary btn-lg me-2"
              type="button"
              (click)="cancel()"
            >
              <i class="fa-solid fa-arrow-left me-2"></i> Huỷ
            </button>
            <button
              class="btn btn-lg btn-success px-5"
              type="submit"
              [disabled]="
                !selectedUser ||
                cartCount === 0 ||
                isLoading ||
                userSummary.blocked
              "
            >
              <span
                *ngIf="isLoading"
                class="spinner-border spinner-border-sm me-2"
              ></span>
              <i class="fa-solid fa-check-circle me-2" *ngIf="!isLoading"></i>
              Xác Nhận {{ cartCount }} Sách
            </button>
            <div *ngIf="userSummary.blocked" class="text-danger small mt-2">
              Nút bị khoá: {{ userSummary.blockReason }}
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
