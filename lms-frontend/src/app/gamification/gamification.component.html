<div class="gamification-container">
  <h2>ğŸ® Gamification - Äiá»ƒm thÆ°á»Ÿng & ThÃ nh tÃ­ch</h2>

  <!-- Tabs -->
  <div class="tabs">
    <button
      [class.active]="activeTab === 'stats'"
      (click)="setActiveTab('stats')"
    >
      ğŸ“Š Tá»•ng quan
    </button>
    <button
      [class.active]="activeTab === 'badges'"
      (click)="setActiveTab('badges')"
    >
      ğŸ… Huy hiá»‡u ({{ badges.length }})
    </button>
    <button
      [class.active]="activeTab === 'challenges'"
      (click)="setActiveTab('challenges')"
    >
      ğŸ¯ Thá»­ thÃ¡ch
    </button>
    <button
      [class.active]="activeTab === 'leaderboard'"
      (click)="setActiveTab('leaderboard')"
    >
      ğŸ† Báº£ng xáº¿p háº¡ng
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">Äang táº£i...</div>
  <div *ngIf="error" class="error">{{ error }}</div>

  <!-- Stats Tab -->
  <div *ngIf="activeTab === 'stats' && stats" class="tab-content">
    <div class="stats-grid">
      <!-- Level Card -->
      <div class="stat-card level-card">
        <div class="level-badge">{{ getLevelBadge(stats.currentLevel) }}</div>
        <h3>Cáº¥p Ä‘á»™ {{ stats.currentLevel }}</h3>
        <div class="progress-bar">
          <div
            class="progress"
            [style.width.%]="getProgressToNextLevel()"
          ></div>
        </div>
        <p class="progress-text">
          CÃ²n {{ getPointsToNextLevel() }} Ä‘iá»ƒm Ä‘á»ƒ lÃªn cáº¥p
        </p>
      </div>

      <!-- Points Card -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ’</div>
        <h4>Tá»•ng Ä‘iá»ƒm</h4>
        <p class="stat-value">{{ stats.totalPoints }}</p>
      </div>

      <!-- Rank Card -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ…</div>
        <h4>Xáº¿p háº¡ng</h4>
        <p class="stat-value">#{{ stats.rank }}</p>
      </div>

      <!-- Badges Card -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ–ï¸</div>
        <h4>Huy hiá»‡u</h4>
        <p class="stat-value">{{ stats.badgeCount }}</p>
      </div>

      <!-- Activity Stats -->
      <div class="stat-card">
        <div class="stat-icon">ğŸ“š</div>
        <h4>SÃ¡ch Ä‘Ã£ mÆ°á»£n</h4>
        <p class="stat-value">{{ stats.booksBorrowedCount }}</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <h4>Tráº£ Ä‘Ãºng háº¡n</h4>
        <p class="stat-value">{{ stats.booksReturnedOnTime }}</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon">âœï¸</div>
        <h4>ÄÃ¡nh giÃ¡</h4>
        <p class="stat-value">{{ stats.reviewsWritten }}</p>
      </div>

      <div class="stat-card">
        <div class="stat-icon">ğŸ”¥</div>
        <h4>Streak</h4>
        <p class="stat-value">{{ stats.streakDays }} ngÃ y</p>
      </div>
    </div>
  </div>

  <!-- Badges Tab -->
  <div *ngIf="activeTab === 'badges'" class="tab-content">
    <div class="badges-grid" *ngIf="badges.length > 0">
      <div class="badge-card" *ngFor="let userBadge of badges">
        <div class="badge-icon">
          <img
            *ngIf="userBadge.badge.iconUrl"
            [src]="userBadge.badge.iconUrl"
            alt=""
          />
          <span *ngIf="!userBadge.badge.iconUrl">ğŸ†</span>
        </div>
        <h4>{{ userBadge.badge.nameVi }}</h4>
        <p>{{ userBadge.badge.descriptionVi }}</p>
        <small>Äáº¡t ngÃ y: {{ userBadge.earnedAt | date : "dd/MM/yyyy" }}</small>
      </div>
    </div>
    <div *ngIf="badges.length === 0" class="empty-state">
      <p>ChÆ°a cÃ³ huy hiá»‡u nÃ o. HÃ£y mÆ°á»£n sÃ¡ch vÃ  hoÃ n thÃ nh thá»­ thÃ¡ch!</p>
    </div>
  </div>

  <!-- Challenges Tab -->
  <div *ngIf="activeTab === 'challenges'" class="tab-content">
    <!-- Active Challenges -->
    <h3>ğŸ¯ Thá»­ thÃ¡ch Ä‘ang tham gia</h3>
    <div class="challenges-list" *ngIf="challenges.length > 0">
      <div
        class="challenge-card"
        *ngFor="let progress of challenges"
        [class.completed]="progress.isCompleted"
      >
        <div class="challenge-header">
          <h4>{{ progress.challenge.nameVi }}</h4>
          <span class="reward"
            >+{{ progress.challenge.pointsReward }} Ä‘iá»ƒm</span
          >
        </div>
        <p>{{ progress.challenge.descriptionVi }}</p>
        <div class="challenge-progress">
          <div class="progress-bar">
            <div
              class="progress"
              [style.width.%]="getChallengeProgress(progress)"
            ></div>
          </div>
          <span
            >{{ progress.booksCompleted }}/{{
              progress.challenge.targetBooks
            }}
            sÃ¡ch</span
          >
        </div>
        <div *ngIf="progress.isCompleted" class="completed-badge">
          âœ… HoÃ n thÃ nh!
        </div>
      </div>
    </div>

    <!-- Available Challenges -->
    <h3>ğŸ“‹ Thá»­ thÃ¡ch cÃ³ thá»ƒ tham gia</h3>
    <div class="challenges-list">
      <div
        class="challenge-card available"
        *ngFor="let challenge of activeChallenges"
      >
        <div class="challenge-header">
          <h4>{{ challenge.nameVi }}</h4>
          <span class="reward">+{{ challenge.pointsReward }} Ä‘iá»ƒm</span>
        </div>
        <p>{{ challenge.descriptionVi }}</p>
        <p class="dates">
          {{ challenge.startDate | date : "dd/MM/yyyy" }} -
          {{ challenge.endDate | date : "dd/MM/yyyy" }}
        </p>
        <button
          class="join-btn"
          (click)="joinChallenge(challenge.id)"
          [disabled]="isJoinedChallenge(challenge.id)"
        >
          {{ isJoinedChallenge(challenge.id) ? "ÄÃ£ tham gia" : "Tham gia" }}
        </button>
      </div>
    </div>
  </div>

  <!-- Leaderboard Tab -->
  <div *ngIf="activeTab === 'leaderboard'" class="tab-content">
    <div class="leaderboard">
      <div
        class="leaderboard-item"
        *ngFor="let entry of leaderboard; let i = index"
        [class.top3]="i < 3"
      >
        <div class="rank">
          <span *ngIf="i === 0">ğŸ¥‡</span>
          <span *ngIf="i === 1">ğŸ¥ˆ</span>
          <span *ngIf="i === 2">ğŸ¥‰</span>
          <span *ngIf="i > 2">#{{ i + 1 }}</span>
        </div>
        <div class="user-info">
          <span class="name">{{ entry.userName }}</span>
          <span class="level"
            >{{ getLevelBadge(entry.level) }} Lv.{{ entry.level }}</span
          >
        </div>
        <div class="points">{{ entry.totalPoints }} Ä‘iá»ƒm</div>
        <div class="badges-count">ğŸ–ï¸ {{ entry.badgeCount }}</div>
      </div>
    </div>
  </div>
</div>
