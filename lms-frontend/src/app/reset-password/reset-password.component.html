<main class="auth">
  <div class="auth-bg" aria-hidden="true"></div>

  <section class="auth-card card">
    <h1>Đặt lại mật khẩu</h1>
    <p class="subtitle">Nhập token (nếu cần) và mật khẩu mới của bạn.</p>

    <form #form="ngForm" (ngSubmit)="onSubmit(form)" novalidate>
      <div *ngIf="successMessage" class="alert alert-success" role="status">
        {{ successMessage }}
        <button type="button" class="link btn-link" (click)="navigateToLogin()">Đăng nhập ngay</button>
      </div>
      <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
        {{ errorMessage }}
      </div>

      <div class="field">
        <label for="token">Mã token</label>
        <input
          id="token"
          name="token"
          type="text"
          required
          [(ngModel)]="token"
          [readonly]="tokenLocked"
          #tokenModel="ngModel"
          [class.is-invalid]="tokenModel.invalid && tokenModel.touched"
          placeholder="Dán token trong email"
        />
        <div *ngIf="tokenModel.invalid && tokenModel.touched" class="invalid-feedback">
          Token không được bỏ trống.
        </div>
      </div>

      <div class="field">
        <label for="newPassword">Mật khẩu mới</label>
        <input
          id="newPassword"
          name="newPassword"
          type="password"
          required
          minlength="6"
          [(ngModel)]="newPassword"
          #newPasswordModel="ngModel"
          [class.is-invalid]="newPasswordModel.invalid && newPasswordModel.touched"
          placeholder="Tối thiểu 6 ký tự"
        />
        <div *ngIf="newPasswordModel.invalid && newPasswordModel.touched" class="invalid-feedback">
          Mật khẩu phải có ít nhất 6 ký tự.
        </div>
      </div>

      <div class="field">
        <label for="confirmPassword">Xác nhận mật khẩu</label>
        <input
          id="confirmPassword"
          name="confirmPassword"
          type="password"
          required
          [(ngModel)]="confirmPassword"
          #confirmPasswordModel="ngModel"
          [class.is-invalid]="passwordsMismatch && confirmPasswordModel.touched"
          placeholder="Nhập lại mật khẩu mới"
        />
        <div *ngIf="passwordsMismatch && confirmPasswordModel.touched" class="invalid-feedback">
          Mật khẩu xác nhận chưa khớp.
        </div>
      </div>

      <button class="btn btn-block" type="submit" [disabled]="form.invalid || loading || passwordsMismatch">
        <span *ngIf="loading" class="spinner-border spinner-border-sm mr-1"></span>
        {{ loading ? 'Đang cập nhật...' : 'Cập nhật mật khẩu' }}
      </button>

      <div class="text-center mt-3">
        <a routerLink="/login" class="link">← Quay lại đăng nhập</a>
      </div>
    </form>
  </section>
</main>
