<div class="container mt-5">
  <div *ngIf="isLoading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Đang tải...</span>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <div *ngIf="book && !isLoading" class="card book-details-card border-secondary shadow-sm" style="background-color: #161b22; color: #c9d1d9;">
    <div class="row g-0">
      <div class="col-md-4 text-center p-4 border-end border-secondary">
        <img [src]="book.coverUrl || 'assets/images/placeholder.png'" 
             class="book-cover-img rounded shadow mb-4" 
             style="max-width: 100%; height: auto; max-height: 400px; object-fit: cover;"
             alt="Bìa sách {{ book.name }}">
        
        <div class="card mt-3 border-secondary" style="background-color: #0d1117;">
            <div class="card-body text-center">
              <h6 class="card-title text-warning mb-3 fw-bold">
                  <i class="fa-solid fa-qrcode me-2"></i>Mã Sách (ID)
              </h6>
              <div class="bg-white p-2 d-inline-block rounded">
                <qrcode [qrdata]="book.id.toString()" [width]="150" [errorCorrectionLevel]="'M'"></qrcode>
              </div>
              <p class="small text-muted mt-2 mb-0">Quét mã để mượn nhanh</p>
            </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card-body p-4">
          <h2 class="card-title text-primary fw-bold mb-3">{{ book.name }}</h2>
          
          <h5 class="card-subtitle mb-3 text-muted">
            <i class="fa-solid fa-pen-nib me-2"></i>
            <span *ngFor="let a of book.authors; let last = last">{{ a.name }}{{ !last ? ', ' : '' }}</span>
          </h5>
          
          <p class="card-text mb-4">
            <span *ngFor="let c of book.categories" class="badge bg-secondary me-2">{{ c.name }}</span>
            <span class="text-muted ms-2"><i class="fa-solid fa-calendar-days me-1"></i> Xuất bản năm {{ book.publishedYear }}</span>
          </p>
          
          <hr class="border-secondary">
          
          <div class="row mb-4">
              <div class="col-md-6">
                  <p><strong>ISBN:</strong> {{ book.isbn }}</p>
                  <p><strong>Tình trạng:</strong> 
                    <span [ngClass]="book.numberOfCopiesAvailable > 0 ? 'text-success fw-bold' : 'text-danger fw-bold'">
                      {{ book.numberOfCopiesAvailable > 0 ? 'Còn ' + book.numberOfCopiesAvailable + ' cuốn' : 'Hết hàng' }}
                    </span>
                  </p>
              </div>
          </div>
          
          <div class="description-box p-3 rounded mb-4" style="background-color: #21262d;">
             <h6 class="text-info mb-2">Mô tả nội dung:</h6>
             <p class="mb-0 text-muted">
                Đây là cuốn sách nổi tiếng thuộc thể loại {{ book.categories[0]?.name }}. 
                Sách hiện đang có sẵn tại thư viện trường THCS Phương Tú.
             </p>
          </div>
          
          <div class="d-flex gap-3">
            <button *ngIf="isUser" class="btn btn-primary px-4" (click)="navigateToBorrow()" [disabled]="book.numberOfCopiesAvailable === 0">
                <i class="fa-solid fa-cart-plus me-2"></i> Mượn Sách Này
            </button>
            <button *ngIf="isUser" class="btn btn-outline-danger px-4" (click)="toggleWishlist()">
                <i class="fa-heart me-2" [ngClass]="book.isWishlisted ? 'fa-solid text-danger' : 'fa-regular'"></i>
                {{ book.isWishlisted ? 'Đã yêu thích' : 'Thêm vào yêu thích' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="book && !isLoading" class="reviews-section mt-5">
    <h4 class="mb-4 text-light border-bottom border-secondary pb-2">
        <i class="fa-solid fa-comments me-2"></i>Đánh giá từ độc giả
    </h4>

    <div *ngIf="reviewsSummary" class="average-rating mb-4 p-3 rounded" style="background-color: #21262d;">
      <ng-container *ngIf="reviewsSummary.averageRating > 0; else noReviews">
        <span class="h5 text-warning me-2">{{ reviewsSummary.averageRating | number:'1.1-1' }} <i class="fa-solid fa-star"></i></span>
        <span class="text-muted">trên 5 ({{ reviewsSummary.reviews.length }} lượt đánh giá)</span>
      </ng-container>
      <ng-template #noReviews>
        <p class="text-muted mb-0">Chưa có đánh giá nào cho sách này.</p>
      </ng-template>
    </div>

    <div *ngIf="isUser && !isCheckingPermission && userCanReview" class="card mb-4 bg-dark border-secondary">
      <div class="card-body">
          <h5 class="card-title text-light mb-3">Viết đánh giá của bạn</h5>
          <form (ngSubmit)="submitReview()">
            <div class="mb-3">
              <label class="form-label text-muted">Điểm số:</label>
              <div class="star-rating fs-3 text-warning" style="cursor: pointer;">
                <span *ngFor="let star of [1,2,3,4,5]" (click)="newReview.rating = star">
                    <i class="fa-star" [ngClass]="star <= newReview.rating ? 'fa-solid' : 'fa-regular'"></i>
                </span>
              </div>
            </div>
            <div class="mb-3">
              <textarea class="form-control bg-dark text-light border-secondary" 
                        [(ngModel)]="newReview.comment" name="comment" rows="3" 
                        placeholder="Chia sẻ cảm nhận của bạn về cuốn sách..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Gửi Đánh Giá</button>
          </form>
      </div>
    </div>
    
    <div *ngIf="isUser && !isCheckingPermission && !userCanReview" class="alert alert-info bg-dark border-info text-info">
      <i class="fa-solid fa-check-circle me-2"></i> Bạn đã đánh giá sách này rồi. Cảm ơn bạn!
    </div>

    <div *ngIf="reviewsSummary && reviewsSummary.reviews.length > 0" class="review-list">
      <div *ngFor="let review of reviewsSummary.reviews" class="card mb-3 bg-dark border-secondary">
        <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
                <strong class="text-info">{{ review.userName }}</strong>
                <small class="text-muted">{{ review.createdAt | date:'dd/MM/yyyy' }}</small>
            </div>
            <div class="mb-2 text-warning">
                <i class="fa-solid fa-star" *ngFor="let i of [].constructor(review.rating)"></i>
            </div>
            <p class="card-text text-light mb-0">{{ review.comment }}</p>
        </div>
      </div>
    </div>
  </div>
</div>