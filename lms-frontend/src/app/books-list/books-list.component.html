<h2>Book List</h2>

<!-- Controls: Search + Pagination -->

<div class="d-flex align-items-center justify-content-between mb-3" style="gap: 12px;">
<div class="input-group" style="max-width: 420px;">
<span class="input-group-text">ðŸ”Ž</span>
<input class="form-control"
type="text"
placeholder="Search by ID, name, author, genre, year, ISBN..."
[(ngModel)]="searchTerm"
(ngModelChange)="applyFilters(1)">
<button class="btn btn-outline-secondary" *ngIf="searchTerm" (click)="searchTerm=''; applyFilters(1)">Clear</button>
</div>

<div class="d-flex align-items-center" style="gap:8px;">
<small class="text-muted me-2">
{{ filteredRows.length }} results â€¢ Page {{ page }} / {{ totalPages }}
</small>
<button class="btn btn-sm btn-outline-secondary" (click)="setPage(1)" [disabled]="page===1">Â« First</button>
<button class="btn btn-sm btn-outline-secondary" (click)="prevPage()" [disabled]="page===1">â€¹ Prev</button>
<button class="btn btn-sm btn-outline-secondary" (click)="nextPage()" [disabled]="page===totalPages">Next â€º</button>
<button class="btn btn-sm btn-outline-secondary" (click)="setPage(totalPages)" [disabled]="page===totalPages">Last Â»</button>

<select class="form-select form-select-sm ms-2" style="width:auto;"
        [ngModel]="pageSize" (ngModelChange)="changePageSize($event)">
  <option *ngFor="let s of pageSizes" [ngValue]="s">{{ s }} / page</option>
</select>

</div>
</div>

<div class="table-responsive">
<table class="table table-hover align-middle">
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Author</th>
<th>Genre</th>
<th>Published</th>
<th>ISBN</th>
<th>Available</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
<tr *ngIf="pagedRows.length === 0">
<td colspan="8" class="text-center text-muted py-4">No matching results found.</td>
</tr>
<tr *ngFor="let r of pagedRows">
<td>{{ r.id }}</td>
<td>{{ r.name }}</td>
<td>{{ r.author }}</td>
<td>{{ r.genre }}</td>
<td>{{ r.publishedYear || '-' }}</td>
<td>{{ r.isbn || '-' }}</td>
<td [class.text-danger]="r.available === 0">{{ r.available }}</td>
<td>
<div class="btn-group">
<button (click)="bookDetails(r.id)" class="btn btn-sm btn-outline-success">View</button>
<button (click)="updateBook(r.id)" class="btn btn-sm btn-outline-info">Edit</button>
<button (click)="deleteBook(r)" class="btn btn-sm btn-outline-danger">Delete</button>
</div>
<div class="btn-group ms-2">
<button class="btn btn-sm btn-primary" [disabled]="r.available === 0 || isLoading(r.id)" (click)="openBorrow(r)">
Borrow
</button>
<button class="btn btn-sm btn-warning" [disabled]="isLoading(r.id)" (click)="openReserve(r)">
Reserve
</button>
</div>
</td>
</tr>
</tbody>
</table>
</div>

<!-- ===== Borrow Modal ===== -->

<div class="modal fade show" [ngStyle]="{display: showBorrow ? 'block' : 'none'}" *ngIf="showBorrow">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content borrow-modal">
<div class="modal-header">
<h5 class="modal-title">
Create Loan
<small *ngIf="borrowingRow" class="d-block text-muted">
Book: {{ borrowingRow?.name }}
</small>
</h5>
<button type="button" class="btn-close" (click)="closeBorrow()"></button>
</div>
<div class="modal-body">
<form #borrowFormRef="ngForm" (ngSubmit)="submitBorrow()">
<div class="mb-3">
<label class="form-label">Member ID</label>
<input type="number" class="form-control" [(ngModel)]="borrowForm.memberId" name="memberId" required />
</div>
<div class="mb-3">
<label class="form-label">Due Date</label>
<input type="date" class="form-control" [(ngModel)]="borrowForm.dueDate" name="dueDate" required />
</div>
<div class="d-flex justify-content-end gap-2">
<button type="button" class="btn btn-secondary" (click)="closeBorrow()">Cancel</button>
<button class="btn btn-primary" type="submit" [disabled]="borrowFormRef.invalid">Create Loan</button>
</div>
</form>
</div>
</div>
</div>
</div>
<div class="modal-backdrop fade show" *ngIf="showBorrow"></div>

<!-- ===== Reserve Modal ===== -->

<div class="modal fade show" [ngStyle]="{display: showReserve ? 'block' : 'none'}" *ngIf="showReserve">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content borrow-modal">
<div class="modal-header">
<h5 class="modal-title">
Create Reservation
<small *ngIf="reservingRow" class="d-block text-muted">
Book: {{ reservingRow?.name }}
</small>
</h5>
<button type="button" class="btn-close" (click)="closeReserve()"></button>
</div>
<div class="modal-body">
<form #reserveFormRef="ngForm" (ngSubmit)="submitReserve()">
<div class="mb-3">
<label class="form-label">Member ID</label>
<input type="number" class="form-control" [(ngModel)]="reserveForm.memberId" name="memberId" required />
</div>
<div class="d-flex justify-content-end gap-2">
<button type="button" class="btn btn-secondary" (click)="closeReserve()">Cancel</button>
<button class="btn btn-warning" type="submit" [disabled]="reserveFormRef.invalid">Create Reservation</button>
</div>
</form>
</div>
</div>
</div>
</div>
<div class="modal-backdrop fade show" *ngIf="showReserve"></div>

<!-- ===== Modal xÃ¡c nháº­n xÃ³a ===== -->
<div class="modal fade show" [ngStyle]="{display: bookToDelete ? 'block' : 'none'}" *ngIf="bookToDelete">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content borrow-modal">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Deletion</h5>
        <button type="button" class="btn-close" (click)="bookToDelete = null"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the book "<strong>{{ bookToDelete.name }}</strong>"?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="bookToDelete = null">Cancel</button>
        <button class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade show" *ngIf="bookToDelete"></div>